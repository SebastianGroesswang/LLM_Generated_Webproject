<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detailansicht - SWAPI Person</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link href="style.css" rel="stylesheet">
  <style>body{background:#f2f3f5}</style>
</head>
<body>
  <!-- NAVBAR: Logo links (verweist auf index.html) und rechts Link zurück zur Home -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <img src="./assets/star-wars-logo-small.png" alt="Star Wars" width="36" height="36" class="me-2" onerror="this.style.display='none'">
        <span class="fw-semibold">Star Wars</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#detailNav" aria-controls="detailNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-end" id="detailNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="card mb-3">
      <div class="card-body">
        <h1 class="h4 mb-2" id="title">Person — Detail</h1>
        <p class="text-muted" id="subtitle">Lädt die Daten anhand der id in der URL (z.B. detail.html?id=4)</p>
      </div>
    </div>

    <section id="content">
      <div class="card">
        <div class="card-body">
          <div id="status" class="text-center py-4">
            <div class="spinner-border" role="status"><span class="visually-hidden">Lädt...</span></div>
          </div>

          <div id="details" class="d-none">
            <div class="mb-3">
              <h2 class="h6 d-flex align-items-center justify-content-between">
                Rohdaten (JSON)
                <button class="btn btn-sm btn-outline-secondary" type="button"
                        data-bs-toggle="collapse" data-bs-target="#rawCollapse"
                        aria-expanded="false" aria-controls="rawCollapse">
                  Rohdaten anzeigen
                </button>
              </h2>

              <div class="collapse mt-2" id="rawCollapse">
                <pre id="raw" class="bg-light p-3 rounded" style="max-height:300px;overflow:auto"></pre>
              </div>
            </div>

            <!-- Neues Grid für gruppierte Felder -->
            <div id="groups" class="row g-3">
              <!-- Inhalte werden per JS eingefügt -->
            </div>

          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Einfaches Escaping
    function esc(s){ return String(s===null||s===undefined?'':s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

    // Hilfsfunktionen
    function lastIdFromUrl(url){
      try{
        const m = String(url).match(/\/(\d+)\/?$/);
        return m ? m[1] : null;
      }catch(e){return null;}
    }

    const filmMap = {
      "1":"A New Hope",
      "2":"The Empire Strikes Back",
      "3":"Return of the Jedi",
      "4":"The Phantom Menace",
      "5":"Attack of the Clones",
      "6":"Revenge of the Sith"
    };

    function linkListFromUrls(urls){
      if(!Array.isArray(urls) || urls.length===0) return '<span class="text-muted">—</span>';
      return '<ul class="mb-0">' + urls.map(u =>
        '<li><a href="' + esc(u) + '" target="_blank" rel="noopener">' + esc(u) + '</a></li>'
      ).join('') + '</ul>';
    }

    function makeCard(colClass, title, innerHTML){
      return '<div class="' + colClass + '"><div class="card h-100"><div class="card-body">' +
             '<h3 class="h6 mb-2">' + esc(title) + '</h3>' + innerHTML +
             '</div></div></div>';
    }

    // Lese id aus URL
    const params = new URLSearchParams(location.search);
    const id = params.get('id') || '1';
    const statusEl = document.getElementById('status');
    const detailsEl = document.getElementById('details');
    const rawEl = document.getElementById('raw');
    const groupsEl = document.getElementById('groups');
    const titleEl = document.getElementById('title');
    titleEl.textContent = 'Person — Detail (id=' + esc(id) + ')';

    // Fetch mit then/catch
    fetch('https://swapi.info/api/people/' + encodeURIComponent(id))
      .then(res => {
        if(!res.ok) throw new Error('Netzwerkfehler: ' + res.status);
        return res.json();
      })
      .then(json => {
        // Roh-JSON
        rawEl.textContent = JSON.stringify(json, null, 2);

        // Gruppierung: Persönliche Daten
        const name = json.name || '—';
        const birth = json.birth_year || '—';
        const gender = json.gender || '—';
        const speciesArr = Array.isArray(json.species) ? json.species : [];
        const speciesHtml = speciesArr.length ? speciesArr.map(u=>'<li><a href="'+esc(u)+'" target="_blank" rel="noopener">'+esc(u)+'</a></li>').join('') : '';

        const personalInner = '<ul class="list-unstyled mb-0">' +
          '<li><strong>Name: </strong> ' + esc(name) + '</li>' +
          '<li><strong>Birth year: </strong> ' + esc(birth) + '</li>' +
          '<li><strong>Gender: </strong> ' + esc(gender) + '</li>' +
          (speciesArr.length ? '<li><strong>Species:</strong> <ul class="mb-0">' + speciesHtml + '</ul></li>' : '') +
          '</ul>';

        // Aussehen
        const appearanceInner = '<ul class="list-unstyled mb-0">' +
          '<li><strong>Height: </strong> ' + esc(json.height || '—') + '</li>' +
          '<li><strong>Mass: </strong> ' + esc(json.mass || '—') + '</li>' +
          '<li><strong>Hair color: </strong> ' + esc(json.hair_color || '—') + '</li>' +
          '<li><strong>Skin color: </strong> ' + esc(json.skin_color || '—') + '</li>' +
          '<li><strong>Eye color: </strong> ' + esc(json.eye_color || '—') + '</li>' +
          '</ul>';

        // Filme: extrahiere ID und ersetze durch Titel
        const films = Array.isArray(json.films) ? json.films : [];
        const filmsHtml = films.length
          ? '<ul class="mb-0">' + films.map(u => {
              const fid = lastIdFromUrl(u) || '?';
              const title = filmMap[fid] || ('Film #' + fid);
              return '<li>' + esc(title) + '</li>';
            }).join('') + '</ul>'
          : '<span class="text-muted">—</span>';

        // Fahrzeuge & Raumschiffe: Summe + collapse mit Links
        const vehicles = Array.isArray(json.vehicles) ? json.vehicles : [];
        const starships = Array.isArray(json.starships) ? json.starships : [];
        const totalVS = vehicles.length + starships.length;
        const vsCollapseId = 'vsCollapse_' + esc(id);
        const combinedLinks = vehicles.concat(starships);
        const combinedListHtml = combinedLinks.length
          ? '<ul class="mb-0">' + combinedLinks.map(u => '<li><a href="'+esc(u)+'" target="_blank" rel="noopener">'+esc(u)+'</a></li>').join('') + '</ul>'
          : '<span class="text-muted">—</span>';

        const vsInner = '<p class="mb-2"><strong>Summe:</strong> ' + esc(String(totalVS)) + '</p>' +
          '<button class="btn btn-sm btn-outline-secondary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#' + vsCollapseId + '" aria-expanded="false" aria-controls="' + vsCollapseId + '">Auflisten</button>' +
          '<div class="collapse" id="' + vsCollapseId + '">' + combinedListHtml + '</div>';

        // Build grid: 2 cols on md for personal & appearance, films full width, vehicles col
        groupsEl.innerHTML =
          makeCard('col-12 col-md-6', 'Persönliche Daten', personalInner) +
          makeCard('col-12 col-md-6', 'Aussehen', appearanceInner) +
          makeCard('col-12', 'Filme', filmsHtml) +
          makeCard('col-12 col-md-6', 'Raumschiffe und Fahrzeuge', vsInner);

        statusEl.classList.add('d-none');
        detailsEl.classList.remove('d-none');
      })
      .catch(err => {
        statusEl.innerHTML = '<div class="text-danger">Fehler beim Laden: ' + esc(err.message) + '</div>';
        console.error(err);
      });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

</body>
</html>

